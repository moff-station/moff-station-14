name: REUSE Header Check (PR)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  reuse:
    name: REUSE headers (changed files only)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        token: ${{ secrets.PR_BOT_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: License + change gate
      id: license_gate
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PR_BOT_TOKEN }} 
        script: |
          function createMissingLicenseMessage() {
            return [
              "❌ **Pull Request Closed: Missing License Declaration**",
              "",
              "This PR modifies files under **Content.*/Resources**, which require a license declaration.",
              "",
              "Please include:",
              "",
              "```md",
              "## License",
              "MIT",
              "```",
              "",
              "Accepted licenses:",
              "- `MIT`",
              "- `AGPL-3.0-or-later`"
            ].join("\n");
          }
          
          function createInvalidLicenseMessage(license) {
            return [
              "❌ **Pull Request Closed: Invalid License**",
              "",
              "This PR modifies files under **Content.*/Resources**, but specifies an invalid license:",
              "",
              "```",
              license,
              "```",
              "",
              "Accepted licenses:",
              "- `MIT`",
              "- `AGPL-3.0-or-later`"
            ].join("\n");
          }
          
          const pr = context.payload.pull_request;
          const body = pr.body || "";
          
          // Fetch PR files
          const files = await github.paginate(
            github.rest.pulls.listFiles,
            {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100,
            }
          );
          
          const relevantFiles = files
            .map(f => f.filename)
            .filter(f =>
              /^(Content\.[^/]+|Resources)\//.test(f) &&
              /\.(cs|yml|yaml)$/.test(f)
            );
          
          if (relevantFiles.length === 0) {
            core.setOutput("continue", "true");
            core.setOutput("check_reuse", "false");
            return;
          }
          
          // Extract license
          const lines = body.split(/\r?\n/);
          let license = null;
          
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === "## License") {
              for (let j = i + 1; j < lines.length; j++) {
                const v = lines[j].trim();
                if (v) {
                  license = v;
                  break;
                }
              }
              break;
            }
          }
          
          const allowed = ["MIT", "AGPL-3.0-or-later"];
          
          async function closePR(message) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message,
            });
          
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: "closed",
            });
          }
          
          if (!license) {
            await closePR(createMissingLicenseMessage());
            core.setOutput("continue", "false");
            return;
          }
          
          if (!allowed.includes(license)) {
            await closePR(createInvalidLicenseMessage(license));
            core.setOutput("continue", "false");
            return;
          }
          
          core.exportVariable("REUSE_LICENSE", license);
          core.setOutput("continue", "true");
          core.setOutput("check_reuse", "true");

    - name: Collect changed files
      if: steps.license_gate.outputs.continue == 'true'
      run: |
        git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

    - name: Process REUSE headers
      if: steps.license_gate.outputs.continue == 'true'
      run: |
        FILES=""
        
        while read -r file; do
          case "$file" in
            Content.*/*.cs|Content.*/*.yml|Content.*/*.yaml|\
            Resources/*.cs|Resources/*.yml|Resources/*.yaml)
              if [ -f "$file" ]; then
                FILES="$FILES $file"
              fi
              ;;
          esac
        done < changed_files.txt
        
        if [ -z "$FILES" ]; then
          echo "No relevant files changed — skipping REUSE check."
          exit 0
        fi
        
        echo "Processing files: $FILES"
        python3 Tools/REUSE/process_reuse_headers_for_pr.py $FILES

    - name: Commit changes
      if: steps.license_gate.outputs.continue == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore: Update REUSE headers"
        commit_user_name: "github-actions[bot]"
        commit_user_email: "github-actions[bot]@users.noreply.github.com"
        commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        skip_dirty_check: false
        skip_fetch: true
        push_options: "--force"
        branch: ${{ github.head_ref }}
