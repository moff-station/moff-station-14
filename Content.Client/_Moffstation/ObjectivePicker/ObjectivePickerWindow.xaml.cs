using Content.Client.UserInterface.Controls;
using Content.Shared._DV.CustomObjectiveSummary;
using Content.Shared._Moffstation.Objectives;
using Content.Shared.Mind;
using Content.Shared.Objectives.Systems;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Robust.Shared.Utility;

namespace Content.Client._Moffstation.ObjectivePicker;

[GenerateTypedNameReferences]
public sealed partial class ObjectivePickerWindow : FancyWindow
{
    [Dependency] private readonly IPlayerManager _players = default!;
    [Dependency] private readonly IEntityManager _entity = default!;
    [Dependency] private readonly IGameTiming _gameTiming = default!;

    private SharedObjectivesSystem _objectives = default!;

    private SharedMindSystem? _mind;

    private TimeSpan _nextTextUpdate = TimeSpan.Zero;

    public event Action<string>? OnSubmitted;
    public event Action<string>? UpdateText;

    public ObjectivePickerWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);


        // SubmitButton.OnPressed +=
        //     _ => OnSubmitted?.Invoke(Rope.Collapse(ObjectiveSummaryTextEdit.TextRope));
        // ObjectiveSummaryTextEdit.OnTextChanged += _ =>
        // {
        //     UpdateWordCount();
        //     if (ObjectiveSummaryTextEdit.TextLength > _maxLength || _gameTiming.CurTime < _nextTextUpdate)
        //         return;
        //     UpdateText?.Invoke(Rope.Collapse(ObjectiveSummaryTextEdit.TextRope));
        //     _nextTextUpdate = _gameTiming.CurTime + TimeSpan.FromSeconds(5);
        // };

        _mind ??= _entity.System<SharedMindSystem>();

        _mind.TryGetMind(_players.LocalSession, out var mindUid, out var mindComp);

        if (!_entity.TryGetComponent<PotentialObjectivesComponent>(mindUid, out var potentialObjectivesComponent))
            return;

        foreach (var objective in potentialObjectivesComponent.ObjectiveOptions)
        {
            if (_objectives.GetInfo(objective, mindUid, mindComp) is not { } info)
                return;

            var objectiveBox = new ObjectivePickerEntry
            {
                Objective = info,
                MainButton =
                {
                    Text = info.Title
                },
                ObjectiveTitle =
                {
                    Text = info.Title,
                },
            };

            ObjectiveList.Children.Add(objectiveBox);
        }
    }
}
